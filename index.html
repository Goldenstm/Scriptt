<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FC Stickers ‚Äî Fusion Cam√©ra int√©gr√©e</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg-1:#0d0d17;--card:#141428;--muted:#9aa0d6;--accent:#5f6ef8;--glass:rgba(255,255,255,0.03);--radius:14px}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;color:#fff;background:linear-gradient(180deg,var(--bg-1),#070712)}
    .top-bar{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--glass)}
    .btn-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:var(--card);border:1px solid var(--glass);cursor:pointer}
    .title-pill{padding:8px 16px;border-radius:999px;background:linear-gradient(90deg, rgba(95,110,248,0.12), rgba(123,75,214,0.06));color:var(--muted);font-weight:600}
    .content{padding:14px;display:flex;flex-direction:column;gap:12px}
    .card{background:var(--card);border-radius:var(--radius);padding:12px;border:1px solid var(--glass);box-shadow:0 10px 30px rgba(0,0,0,0.45)}
    .card.large{height:160px}
    .card.medium{height:120px}
    .section-title{font-weight:700;margin-bottom:8px}
    .muted{color:var(--muted);font-size:13px}
    /* Photo button & swipe */
    .photo-wrap{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;width:96px;height:96px;display:flex;align-items:center;justify-content:center;z-index:60}
    .photo-btn{width:74px;height:74px;border-radius:50%;background:linear-gradient(180deg,var(--accent),#7b4bd6);display:flex;align-items:center;justify-content:center;font-size:26px;border:4px solid rgba(255,255,255,0.06);box-shadow:0 10px 30px rgba(95,110,248,0.15);touch-action:none;transition:transform .18s ease, background .18s ease}
    .photo-halo{position:absolute;left:50%;transform:translateX(-50%);bottom:8px;width:110px;height:110px;border-radius:50%;background:radial-gradient(circle, rgba(95,110,248,0.08), transparent 40%);pointer-events:none}
    .swipe-hint{position:fixed;bottom:130px;left:50%;transform:translateX(-50%);display:flex;gap:36px;align-items:center;color:var(--muted);font-size:13px}
    .swipe-chip{background:rgba(255,255,255,0.02);padding:8px 12px;border-radius:999px;border:1px solid var(--glass)}
    .btn-red{background:linear-gradient(180deg,#b91c1c,#ef4444)}
    .btn-blue{background:linear-gradient(180deg,#1f6feb,#3b82f6)}
    .zone-popup{position:fixed;left:50%;transform:translateX(-50%) translateY(-10px);top:16px;width:calc(100% - 40px);max-width:520px;padding:12px;border-radius:12px;background:linear-gradient(180deg,#171725,#0f1020);border:1px solid rgba(95,110,248,0.12);box-shadow:0 14px 30px rgba(0,0,0,0.6);z-index:70;opacity:0;pointer-events:none;transition:all .35s cubic-bezier(.2,.9,.2,1)}
    .zone-popup.show{opacity:1;pointer-events:auto;transform:translateX(-50%) translateY(0)}
    .pages{position:relative;overflow:hidden}
    .page{min-height:70vh;padding-bottom:160px;transition:transform .45s cubic-bezier(.2,.9,.2,1);position:relative}
    .page-inner{max-width:960px;margin:0 auto}
    .camera-frame{width:100%;height:380px;background:linear-gradient(135deg,#0f1018,#0b0b12);border-radius:12px;display:flex;align-items:center;justify-content:center;border:1px solid var(--glass);overflow:hidden}
    .preview-image{max-width:100%;max-height:100%;object-fit:cover}
    .fade-scale{animation:fadeScale .32s ease both}
    @keyframes fadeScale{from{opacity:0;transform:scale(.97)}to{opacity:1;transform:scale(1)}}
    /* Fullscreen camera (BeReal-like) */
    .cam-shell{position:fixed;inset:0;display:none;flex-direction:column;background:#000;z-index:9999}
    .cam-shell.active{display:flex}
    .cam-top{height:64px;padding:8px 14px;display:flex;align-items:center;justify-content:space-between}
    .cam-top .time{font-weight:700}
    .cam-view{flex:1;position:relative;overflow:hidden}
    video#camVideo{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000}
    .overlay-ui{position:absolute;inset:0;pointer-events:none}
    .overlay-center{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);pointer-events:auto;display:flex;flex-direction:column;align-items:center;gap:12px}
    .capture-btn{width:92px;height:92px;border-radius:50%;background:rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;border:6px solid rgba(255,255,255,0.14);font-size:28px;color:#fff;cursor:pointer;pointer-events:auto}
    .capture-btn:active{transform:scale(.98)}
    .mini-note{position:absolute;bottom:28px;left:50%;transform:translateX(-50%);pointer-events:auto;color:var(--muted);font-size:13px}
    .thumb-left{position:absolute;left:14px;bottom:28px;pointer-events:auto}
    .switch-right{position:absolute;right:14px;bottom:28px;pointer-events:auto}
    .btn-ghost{padding:8px 10px;border-radius:10px;background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.06);color:#fff}
    .hidden{display:none}
    .message{position:absolute;left:50%;top:12%;transform:translateX(-50%);background:rgba(0,0,0,0.5);padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.05)}
    .confirm-shell{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(3,3,8,0.6),rgba(3,3,8,0.85));z-index:10000}
    .confirm-card{width:94%;max-width:720px;background:var(--card);padding:14px;border-radius:12px;border:1px solid var(--glass);}
    .confirm-img{width:100%;height:60vh;object-fit:cover;border-radius:8px}
    @media(max-width:480px){ .capture-btn{width:82px;height:82px;border:5px solid rgba(255,255,255,0.12);font-size:24px} .camera-frame{height:320px} }
  </style>
</head>
<body>
  <!-- Top bar -->
  <div class="top-bar">
    <div style="display:flex;align-items:center;gap:10px"><div id="btnProfile" class="btn-icon">üë§</div><div class="title-pill">ZONE CAPTUR√âE</div></div>
    <div style="display:flex;gap:8px"><div id="btnShop" class="btn-icon">üõí</div><div id="btnNotif" class="btn-icon">üîî</div></div>
  </div>

  <!-- Zone popup -->
  <div id="zonePopup" class="zone-popup" aria-live="polite">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div>
        <div class="zone-title" style="font-weight:800;color:var(--accent)">Zone captur√©e</div>
        <div class="muted">Vous avez pris le contr√¥le d'un quartier ‚Äî + points √©quipe</div>
      </div>
      <div style="text-align:right;color:var(--muted);font-size:13px">Il y a 2 min</div>
    </div>
  </div>

  <!-- Pages (map / camera placeholder / confirmation page) -->
  <div class="pages" id="pagesContainer">
    <div id="page1" class="page" style="transform:translateX(0)">
      <div class="page-inner content">
        <div id="rankingCard" class="card large"><div class="section-title">Classements</div><div class="muted">Position nationale et dans votre r√©gion</div><div id="rankingContent" style="margin-top:12px"></div></div>
        <div id="lastStickers" class="card large"><div class="section-title">Derniers stickers en activit√©</div><div class="muted">Vos actions r√©centes</div><div id="stickersList" style="margin-top:12px;display:flex;flex-direction:column;gap:8px;max-height:86px;overflow:auto"></div></div>
        <div id="historyCard" class="card medium"><div style="display:flex;justify-content:space-between;align-items:center"><div class="section-title">Historique</div><div class="muted">Actions r√©centes</div></div><div id="historyList" style="margin-top:10px;display:flex;flex-direction:column;gap:8px;max-height:68px;overflow:auto"></div></div>
      </div>
    </div>

    <div id="page2" class="page" style="transform:translateX(100%)">
      <div class="page-inner content">
        <div class="section-title">üì∑ Prendre une photo</div>
        <div class="card">
          <div class="camera-frame" id="cameraFrame">
            <div id="cameraPlaceholder" style="text-align:center;color:var(--muted)"><div style="font-size:48px">üì∑</div><div>Appuyez sur Capturer ou utilisez la galerie</div></div>
            <video id="videoPreview" style="display:none;width:100%;height:100%;object-fit:cover" autoplay playsinline></video>
            <img id="imagePreview" style="display:none;max-width:100%;max-height:100%;object-fit:cover" />
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <button id="takePictureBtn" class="btn" style="background:linear-gradient(90deg,var(--accent),#7b4bd6);">D√©marrer la cam√©ra</button>
            <button id="captureBtn" class="btn" style="display:none">üì∏ Capturer</button>
            <label for="fileInput" class="btn btn-ghost" style="border:1px solid var(--glass);">üñºÔ∏è Choisir depuis la galerie</label>
            <input type="file" id="fileInput" style="display:none" accept="image/*" />
            <button id="retakeBtn" class="btn btn-ghost" style="display:none">üîÑ Reprendre</button>
            <button id="continueBtn" class="btn" style="display:none;background:linear-gradient(90deg,#f59e0b,#d97706)">‚û°Ô∏è Continuer</button>
          </div>
        </div>
      </div>
    </div>

    <div id="page3" class="page" style="transform:translateX(200%)">
      <div class="page-inner content">
        <div class="section-title">‚úÖ Confirmer le sticker</div>
        <div class="card" id="confirmCard">
          <div style="display:grid;grid-template-columns:1fr;gap:12px">
            <div style="display:flex;gap:12px;align-items:center">
              <div style="width:120px;height:120px;border-radius:12px;overflow:hidden;border:1px solid var(--glass);background:#000;display:flex;align-items:center;justify-content:center" id="finalImageWrap"><img id="finalImage" style="max-width:100%;height:100%;object-fit:cover"/></div>
              <div style="flex:1">
                <div id="confirmType" style="font-weight:800;font-size:18px">Type</div>
                <div id="confirmPoints" class="muted" style="margin-top:6px">Points</div>
                <div id="confirmWhen" class="muted" style="margin-top:6px">Heure</div>
              </div>
            </div>

            <div>
              <label class="muted">Club</label>
              <select id="clubInput" style="width:100%;padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04)"></select>
            </div>

            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button id="deleteBtn" class="btn" style="background:linear-gradient(90deg,#ef4444,#b91c1c)">üóëÔ∏è Supprimer</button>
              <button id="saveBtn" class="btn" style="background:linear-gradient(90deg,#10b981,#059669)">üíæ Enregistrer</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Photo button (fixed) -->
  <div class="photo-wrap">
    <div class="photo-halo" aria-hidden="true"></div>
    <div id="photoBtn" class="photo-btn" role="button" aria-label="Prendre photo">üì∑</div>
  </div>

  <!-- Camera full-screen shell (BeReal-like) -->
  <div id="cameraShell" class="cam-shell" aria-hidden="true">
    <div class="cam-top">
      <div class="time" id="camTime">--:--</div>
      <div style="display:flex;gap:8px"><div id="flipInfo" class="btn-ghost">Arri√®re</div></div>
    </div>
    <div class="cam-view">
      <video id="camVideo" autoplay playsinline muted></video>
      <div class="overlay-ui">
        <div class="message hidden" id="camMessage"></div>
        <div class="overlay-center">
          <div id="camCaptureBtn" class="capture-btn" title="Prendre la photo">‚óè</div>
        </div>
        <div class="mini-note">Glisser vers le bas pour quitter</div>
        <div class="thumb-left" id="thumbPreview" style="display:none"><img id="thumbImg" style="width:64px;height:64px;border-radius:8px;object-fit:cover;border:2px solid rgba(255,255,255,0.08)" /></div>
        <div class="switch-right"><button id="closeCam" class="btn-ghost">Fermer</button></div>
      </div>
    </div>
  </div>

  <!-- Confirmation modal (fallback, not used; kept for dev) -->
  <div id="confirmShell" class="confirm-shell" aria-hidden="true">
    <div class="confirm-card">
      <div style="display:flex;justify-content:space-between;align-items:center"><strong id="confirmTypeModal">Type</strong><div id="confirmPts" class="muted">Points</div></div>
      <img id="confirmImage" class="confirm-img" />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px"><button id="confirmCancel" class="btn-ghost">Annuler</button><button id="confirmSave" class="btn">Enregistrer</button></div>
    </div>
  </div>

  <script>
    /* ====== CONFIG ====== */
    const GAME_RULES = { points: { sticker: 1, surstick: 3 }, swipeThreshold: 60 };

    /* ====== App state & DOM refs ====== */
    const appState = { currentPage:1, selectedCoords:null, capturedImage:null, pendingType:'sticker', stream:null, stickers: JSON.parse(localStorage.getItem('stickers_meta')||'[]') };

    const page1 = document.getElementById('page1'), page2 = document.getElementById('page2'), page3 = document.getElementById('page3');
    const photoBtn = document.getElementById('photoBtn');

    // page camera elements
    const cameraShell = document.getElementById('cameraShell');
    const camVideo = document.getElementById('camVideo');
    const camCaptureBtn = document.getElementById('camCaptureBtn');
    const closeCam = document.getElementById('closeCam');
    const camMessage = document.getElementById('camMessage');
    const thumbPreview = document.getElementById('thumbPreview');
    const thumbImg = document.getElementById('thumbImg');
    const camTime = document.getElementById('camTime');

    // page2 small controls (kept)
    const cameraPlaceholder = document.getElementById('cameraPlaceholder');
    const videoPreview = document.getElementById('videoPreview');
    const imagePreview = document.getElementById('imagePreview');
    const captureBtn = document.getElementById('captureBtn');
    const takePictureBtn = document.getElementById('takePictureBtn');
    const retakeBtn = document.getElementById('retakeBtn');
    const continueBtn = document.getElementById('continueBtn');
    const finalImage = document.getElementById('finalImage');

    // confirmation page
    const confirmType = document.getElementById('confirmType');
    const confirmPoints = document.getElementById('confirmPoints');
    const confirmWhen = document.getElementById('confirmWhen');
    const clubInput = document.getElementById('clubInput');

    // notifications
    let notifications = JSON.parse(localStorage.getItem('fs_notifications')||'[]');

    /* ====== UTILITIES ====== */
    function showPage(n){ const offsets = {1:0,2:-100,3:-200}; page1.style.transform = `translateX(${offsets[1]}%)`; page2.style.transform = `translateX(${offsets[2]}%)`; page3.style.transform = `translateX(${offsets[3]}%)`; appState.currentPage = n; }

    function vibrate(ms=40){ if(navigator.vibrate) navigator.vibrate(ms); }
    function pushNotification(title, body){ notifications.unshift({id:Date.now(),title,body,ts:Date.now()}); localStorage.setItem('fs_notifications',JSON.stringify(notifications)); renderNotifications(); }
    function renderNotifications(){ const el=document.getElementById('notifList'); if(!el) return; el.innerHTML=''; if(notifications.length===0){ el.innerHTML='<div class="muted">Aucune notification</div>'; } else notifications.forEach(n=>{ const d=document.createElement('div'); d.style.padding='8px'; d.style.borderRadius='8px'; d.style.background='rgba(255,255,255,0.02)'; d.innerHTML=`<div style="font-weight:700">${n.title}</div><div class="muted">${n.body}</div>`; el.appendChild(d); }); }

    /* ====== Dynamic loaders (unchanged) ====== */
    function mockFetchRanking(){ return new Promise(res=>setTimeout(()=>res({national:{rank:42,points:1240},regional:{region:'√éle-de-France',rank:3,points:320}}),300)); }
    function mockFetchStickers(){ return new Promise(res=>setTimeout(()=>res([{id:1,club:'PSG',action:'pos√©',when:Date.now()-1000*60*5,lat:48.85,lng:2.35},{id:2,club:'OM',action:'sursticker',when:Date.now()-1000*60*30,lat:43.30,lng:5.37}]),200)); }

    async function loadDynamic(){ const r=await mockFetchRanking(); document.getElementById('rankingContent').innerHTML=`<div style="display:flex;justify-content:space-between"><div><strong>France</strong> #${r.national.rank}</div><div><strong>${r.national.points} pts</strong></div></div><div style="margin-top:8px"><strong>${r.regional.region}</strong> #${r.regional.rank} ‚Äî ${r.regional.points} pts</div>`; const s=await mockFetchStickers(); const sl=document.getElementById('stickersList'); sl.innerHTML=''; s.forEach(it=>{ const d=document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.style.alignItems='center'; d.style.padding='10px'; d.style.borderRadius='10px'; d.style.border='1px solid rgba(255,255,255,0.03)'; d.style.background='rgba(255,255,255,0.01)'; d.innerHTML=`<div><div style="font-weight:700">${it.club} ‚Ä¢ ${it.action}</div><div class="muted">${new Date(it.when).toLocaleTimeString()}</div></div><div style="font-size:12px;color:var(--muted)">${it.lat.toFixed(2)}, ${it.lng.toFixed(2)}</div>`; sl.appendChild(d); }); const hist = JSON.parse(localStorage.getItem('fs_history')||'[]'); const hl=document.getElementById('historyList'); hl.innerHTML=''; if(hist.length===0){ hl.innerHTML='<div class="muted">Aucune activit√© r√©cente</div>'; } else { hist.slice(0,6).forEach(h=>{ const el=document.createElement('div'); el.className='muted'; el.textContent=`${h.action} ‚Äî ${h.when}`; hl.appendChild(el); }); } }

    /* ====== Camera (rear-only) implementation merged from the BeReal-like part ====== */
    // Helpers: stop current stream
    function stopStream(){ try{ if(appState.stream){ appState.stream.getTracks().forEach(t=>t.stop()); appState.stream=null; camVideo.srcObject=null; } }catch(e){ console.warn('stopStream',e); } }

    async function getRearDeviceId(){
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoInputs = devices.filter(d => d.kind === 'videoinput');
        if(videoInputs.length===0) return null;
        const rear = videoInputs.find(d => /back|rear|arri√®re|post√©rieur/i.test(d.label));
        if(rear) return rear.deviceId;
        return videoInputs[videoInputs.length-1].deviceId;
      }catch(e){ console.warn('getRearDeviceId error', e); return null; }
    }

    async function startCameraRearOnly(){
      try{
        let deviceId = await getRearDeviceId();
        let constraints;
        if(deviceId){
          constraints = { video: { deviceId: { exact: deviceId } }, audio: false };
        } else {
          constraints = { video: { facingMode: { ideal: 'environment' } }, audio: false };
        }
        const s = await navigator.mediaDevices.getUserMedia(constraints);
        appState.stream = s; camVideo.srcObject = s;
        try{ await camVideo.play(); }catch(e){ console.warn('video play failed', e); }
        camVideo.style.display='block';
        camMessage && camMessage.classList && camMessage.classList.add('hidden');
        return true;
      }catch(err){
        console.error('startCameraRearOnly error', err);
        if(err && (err.name === 'NotAllowedError' || err.name === 'SecurityError')){
          camMessage && (camMessage.textContent = "Permission cam√©ra refus√©e. Active la permission dans les param√®tres du navigateur.");
          camMessage && camMessage.classList.remove('hidden');
        } else {
          camMessage && (camMessage.textContent = "Impossible d'acc√©der √† la cam√©ra. Essaie la galerie.");
          camMessage && camMessage.classList.remove('hidden');
        }
        return false;
      }
    }

    // Open camera: used by swipe logic
    async function openCameraMode(){
      // ensure single instance
      stopStream();
      cameraShell.classList.add('active'); cameraShell.setAttribute('aria-hidden','false');
      await new Promise(r => requestAnimationFrame(()=>r()));
      await new Promise(r => setTimeout(r, 360));
      const ok = await startCameraRearOnly();
      if(!ok){
        // fallback to gallery
        const input = document.createElement('input'); input.type='file'; input.accept='image/*'; input.style.display='none';
        input.addEventListener('change', (e)=>{ const f=e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = (ev)=>{ onCameraCaptured(ev.target.result); }; reader.readAsDataURL(f); });
        document.body.appendChild(input); input.click(); setTimeout(()=>input.remove(),2000);
      }
    }

    function closeCameraMode(){
      stopStream();
      cameraShell.classList.remove('active'); cameraShell.setAttribute('aria-hidden','true');
    }

    // called after capture to integrate with the main flow
    function onCameraCaptured(dataUrl){
      // set captured image in appState, close camera UI, then go to confirmation page 3
      appState.capturedImage = dataUrl;
      // set small thumb on camera UI
      thumbImg.src = dataUrl; thumbPreview.style.display='block';
      // close camera UI
      closeCameraMode();
      // populate confirmation (page 3) and show it
      prepareConfirmation(); showPage(3);
      page3.classList.add('fade-scale'); setTimeout(()=>page3.classList.remove('fade-scale'),360);
    }

    // capture handler inside camera shell
    camCaptureBtn && camCaptureBtn.addEventListener('click', ()=>{
      if(!appState.stream){ camMessage && (camMessage.textContent='Cam√©ra non pr√™te'); camMessage && camMessage.classList.remove('hidden'); setTimeout(()=>camMessage.classList.add('hidden'),1500); return; }
      try{
        const video = camVideo;
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth || 1280;
        canvas.height = video.videoHeight || 720;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
        // stop stream a little later
        setTimeout(()=>{ stopStream(); }, 220);
        onCameraCaptured(dataUrl);
      }catch(err){ console.error('capture error', err); camMessage && (camMessage.textContent='Erreur capture'); camMessage && camMessage.classList.remove('hidden'); setTimeout(()=>camMessage.classList.add('hidden'),2000); }
    });

    // closing camera
    closeCam && closeCam.addEventListener('click', ()=>{ closeCameraMode(); });

    /* ====== Wire swipe button to set pending type and open camera ====== */
    let touchStartX=null, dragging=false;
    photoBtn.addEventListener('touchstart',(e)=>{ const t=e.touches[0]; touchStartX=t.clientX; dragging=true; photoBtn.style.transition='none'; },{passive:true});
    photoBtn.addEventListener('touchmove',(e)=>{ if(!dragging) return; const dx=e.touches[0].clientX - touchStartX; photoBtn.style.transform = `translateX(${dx}px)`; if(dx > GAME_RULES.swipeThreshold){ photoBtn.classList.add('btn-blue'); photoBtn.classList.remove('btn-red'); } else if(dx < -GAME_RULES.swipeThreshold){ photoBtn.classList.add('btn-red'); photoBtn.classList.remove('btn-blue'); } else { photoBtn.classList.remove('btn-red'); photoBtn.classList.remove('btn-blue'); } },{passive:true});
    photoBtn.addEventListener('touchend',(e)=>{ if(!dragging) return; dragging=false; photoBtn.style.transition='transform .18s ease'; photoBtn.style.transform='translateX(0)'; const dx = e.changedTouches[0].clientX - touchStartX; if(dx > GAME_RULES.swipeThreshold){ vibrate(50); appState.pendingType='surstick'; photoBtn.classList.add('btn-blue'); setTimeout(()=>photoBtn.classList.remove('btn-blue'),300); openCameraMode(); } else if(dx < -GAME_RULES.swipeThreshold){ vibrate(50); appState.pendingType='sticker'; photoBtn.classList.add('btn-red'); setTimeout(()=>photoBtn.classList.remove('btn-red'),300); openCameraMode(); } else { appState.pendingType='sticker'; openCameraMode(); } },{passive:true});

    // desktop fallback
    let mouseDown=false, mdStartX=0;
    photoBtn.addEventListener('mousedown',(e)=>{ mouseDown=true; mdStartX=e.clientX; photoBtn.style.transition='none'; });
    document.addEventListener('mousemove',(e)=>{ if(!mouseDown) return; const dx=e.clientX-mdStartX; photoBtn.style.transform=`translateX(${dx}px)`; if(dx>GAME_RULES.swipeThreshold){ photoBtn.classList.add('btn-blue'); photoBtn.classList.remove('btn-red'); } else if(dx<-GAME_RULES.swipeThreshold){ photoBtn.classList.add('btn-red'); photoBtn.classList.remove('btn-blue'); } else { photoBtn.classList.remove('btn-red'); photoBtn.classList.remove('btn-blue'); } });
    document.addEventListener('mouseup',(e)=>{ if(!mouseDown) return; mouseDown=false; photoBtn.style.transition='transform .18s ease'; photoBtn.style.transform='translateX(0)'; const dx=e.clientX-mdStartX; if(dx>GAME_RULES.swipeThreshold){ appState.pendingType='surstick'; openCameraMode(); } else if(dx<-GAME_RULES.swipeThreshold){ appState.pendingType='sticker'; openCameraMode(); } else { appState.pendingType='sticker'; openCameraMode(); } });

    /* ====== Existing capture handlers (page2) kept for compatibility with non-fullscreen flow ====== */
    // If the user uses the small page2 controls, we also support that flow (kept but not preferred).
    async function startCameraSmall(){
      try{
        appState.stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode: 'environment' }, audio:false });
        videoPreview.srcObject = appState.stream; videoPreview.style.display='block'; cameraPlaceholder.style.display='none'; captureBtn.style.display='inline-block'; retakeBtn.style.display='inline-block'; takePictureBtn.style.display='none';
      }catch(err){ console.error('Camera error (small)',err); pushNotification('Erreur cam√©ra','Impossible d\\'acc√©der √† la cam√©ra'); }
    }
    captureBtn && captureBtn.addEventListener('click', ()=>{
      // capture from small cameraPreview
      try{
        const v = videoPreview;
        const canvas = document.createElement('canvas');
        canvas.width = v.videoWidth; canvas.height = v.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(v,0,0);
        const data = canvas.toDataURL('image/jpeg',0.8);
        appState.capturedImage = data;
        imagePreview.src = data; imagePreview.style.display='block'; videoPreview.style.display='none'; captureBtn.style.display='none'; continueBtn.style.display='inline-block';
        stopStream();
        setTimeout(()=>{ prepareConfirmation(); showPage(3); page3.classList.add('fade-scale'); setTimeout(()=>page3.classList.remove('fade-scale'),360); },600);
      }catch(err){ console.error('capture small error', err); pushNotification('Erreur capture','√âchec capture'); }
    });
    takePictureBtn && takePictureBtn.addEventListener('click', ()=>{ showPage(2); startCameraSmall(); });
    retakeBtn && retakeBtn.addEventListener('click', ()=>{ imagePreview.style.display='none'; videoPreview.style.display='none'; cameraPlaceholder.style.display='block'; captureBtn.style.display='none'; retakeBtn.style.display='none'; continueBtn.style.display='none'; takePictureBtn.style.display='inline-block'; stopStream(); appState.capturedImage=null; });

    // file input
    document.getElementById('fileInput').addEventListener('change', (e)=>{ const file = e.target.files[0]; if(!file) return; if(!file.type.startsWith('image/')){ pushNotification('Format non support√©','Choisis une image'); return; } if(file.size > 5*1024*1024){ pushNotification('Fichier trop lourd','Max 5MB'); return; } const reader=new FileReader(); reader.onload=(ev)=>{ appState.capturedImage = ev.target.result; imagePreview.src = appState.capturedImage; imagePreview.style.display='block'; cameraPlaceholder.style.display='none'; videoPreview.style.display='none'; captureBtn.style.display='none'; continueBtn.style.display='inline-block'; retakeBtn.style.display='inline-block'; setTimeout(()=>{ prepareConfirmation(); showPage(3); page3.classList.add('fade-scale'); setTimeout(()=>page3.classList.remove('fade-scale'),360); },500); }; reader.readAsDataURL(file); });

    /* ====== Confirmation / save logic (kept) ====== */
    function prepareConfirmation(){
      finalImage.src = appState.capturedImage || '';
      const t = appState.pendingType || 'sticker';
      confirmType.textContent = (t==='surstick')? 'SURSTICK' : 'STICKER';
      const pts = (t==='surstick')? GAME_RULES.points.surstick : GAME_RULES.points.sticker;
      confirmPoints.textContent = `+${pts} pts`;
      confirmWhen.textContent = new Date().toLocaleString();
      const p = JSON.parse(localStorage.getItem('fs_profile')||'{}'); if(p.club) clubInput.value = p.club; else clubInput.value='';
    }

    async function makeThumbnail(dataUrl, max){
      return new Promise((resolve)=>{
        const img=new Image();
        img.onload=()=>{
          const canvas=document.createElement('canvas');
          let w=img.width,h=img.height;
          if(w>h){ if(w>max){ h=(h*max)/w; w=max; } } else { if(h>max){ w=(w*max)/h; h=max; } }
          canvas.width=w; canvas.height=h; const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h); resolve(canvas.toDataURL('image/jpeg',0.6));
        };
        img.src=dataUrl;
      });
    }

    async function saveSticker(){
      const club = clubInput.value;
      if(!club){ pushNotification('Choisis un club','S√©lectionne le club du maillot'); return; }
      if(!appState.capturedImage){ pushNotification('Aucune photo','Prends ou choisis une photo'); return; }
      let coords = null;
      try{ coords = await new Promise((resolve)=>{ navigator.geolocation.getCurrentPosition(pos=>resolve({lat:pos.coords.latitude,lng:pos.coords.longitude}), err=>{ console.warn('geo err',err); resolve(appState.selectedCoords || null); }, {enableHighAccuracy:true,timeout:7000} ); }); }catch(e){ coords = appState.selectedCoords || null; }
      const thumb = await makeThumbnail(appState.capturedImage,300);
      const type = appState.pendingType || 'sticker';
      const points = (type==='surstick')? GAME_RULES.points.surstick : GAME_RULES.points.sticker;
      const meta = { id:Date.now(), type, timestamp: new Date().toISOString(), club, points, location: coords, thumbnail: thumb };
      appState.stickers.unshift(meta); localStorage.setItem('stickers_meta', JSON.stringify(appState.stickers));
      const hist = JSON.parse(localStorage.getItem('fs_history')||'[]'); hist.unshift({action: (type==='surstick'?'Sursticker pos√©':'Sticker pos√©'), when: new Date().toLocaleTimeString()}); localStorage.setItem('fs_history', JSON.stringify(hist));
      pushNotification('Sticker enregistr√©', `${type==='surstick'?'Surstick':'Stick'} enregistr√© ‚Äî +${points} pts`);
      setTimeout(()=>{ appState.capturedImage=null; showPage(1); loadDynamic(); },900);
    }

    document.getElementById('saveBtn').addEventListener('click', saveSticker);
    document.getElementById('deleteBtn').addEventListener('click', ()=>{ appState.capturedImage=null; showPage(1); pushNotification('Annul√©','Capture annul√©e'); });

    /* ====== Profile modal wiring (unchanged) ====== */
    document.getElementById('btnProfile').addEventListener('click', ()=>{ document.getElementById('profileModal').style.display='flex'; loadProfileToModal(); });
    document.getElementById('closeProfile').addEventListener('click', ()=>{ document.getElementById('profileModal').style.display='none'; });
    document.getElementById('saveProfile').addEventListener('click', ()=>{ const p={username:document.getElementById('pUsername').value,gender:document.getElementById('pGender').value,nationality:document.getElementById('pNationality').value,region:document.getElementById('pRegion').value,club:document.getElementById('pClubModal').value,bio:document.getElementById('pBio').value}; localStorage.setItem('fs_profile',JSON.stringify(p)); localStorage.setItem('profileSetupDone','1'); document.getElementById('profileModal').style.display='none'; });
    function loadProfileToModal(){ const p=JSON.parse(localStorage.getItem('fs_profile')||'{}'); document.getElementById('pUsername').value=p.username||''; document.getElementById('pNationality').value=p.nationality||''; document.getElementById('pRegion').value=p.region||''; document.getElementById('pClubModal').value=p.club||''; document.getElementById('pBio').value=p.bio||''; }

    /* ====== Init ====== */
    (function init(){
      // load clubs for select
      const clubs = ['','PSG','Lyon','OM','Monaco','Lille','Rennes','Nice','Strasbourg','Nantes','Bordeaux','Lens','Saint-Etienne'];
      clubs.forEach(c=>{
        const o = document.createElement('option'); o.value=c; o.textContent = c||'Choisir un club'; clubInput.appendChild(o);
        const o2 = document.createElement('option'); o2.value=c; o2.textContent = c||'Choisir un club'; document.getElementById('pClubModal').appendChild(o2);
      });
      renderNotifications(); loadDynamic();
      if(!localStorage.getItem('profileSetupDone')){ document.getElementById('profileModal').style.display='flex'; }
      if(notifications.length===0) pushNotification('Bienvenue','Glisse sur le bouton photo pour choisir Stick/Surstick puis prends une photo.');
      showPage(1);
      // camera keyboard quick test when debugging
      document.addEventListener('keydown',(e)=>{ if(e.key==='c'){ appState.pendingType='sticker'; openCameraMode(); } if(e.key==='s'){ appState.pendingType='surstick'; openCameraMode(); } });
    })();

    // Expose helper for external/test usage
    window.setPendingAndOpen = function(type){ appState.pendingType = (type==='surstick' ? 'surstick' : 'sticker'); openCameraMode(); };
    window.openCameraMode = openCameraMode;

    // stop camera when visibility lost
    document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ stopStream(); } });

  </script>
</body>
</html>
